ðŸš€ NABCA Extraction Test Script

================================================================================

ðŸ“¦ Setting up AWS and Supabase clients...
âœ… Found section.pdf
ðŸ“„ PDF size: 47145 bytes

ðŸ“¤ Uploading to S3 for Textract...
âœ… Uploaded to s3://inspector-dom-textract/textract-temp/test-nabca-extraction/section.pdf

ðŸ” Starting Textract async analysis...
âœ… Job started: 113c83d7f9282ee2d8bab36b25ab1da07e0a871a936b023c5f4a0398a169386f

â³ Waiting for Textract to complete...
  Status: IN_PROGRESS (0.0s)
  Status: IN_PROGRESS (2.0s)
  Status: IN_PROGRESS (4.1s)
  Status: IN_PROGRESS (6.1s)
âœ… Textract completed in 8.1s

ðŸ“¥ Retrieving Textract results...
âœ… Retrieved 3102 blocks

ðŸ“Š Parsing tables...
âœ… Found 2 tables

ðŸŽ¯ Extracting data with field mapping...

ðŸ” Processing 2 tables...
  Table 1: 53 rows
  Table 2: 53 rows
    Skipping 3 header rows, merging 50 data rows

âœ… Merged table data: 103 total rows

ðŸ“Š RAW TABLE DATA (103 rows total):
  Row 0: ['ALL CONTROL STATES-JANUARY', '2025', '']... (showing first 3 cells)
  Row 1: ['', '', '']... (showing first 3 cells)
  Row 2: ['BRAND', 'Type', 'Rank']... (showing first 3 cells)
  Row 3: ['TITO HANDMADE', 'VODKA-CLASSIC-DOM', '1']... (showing first 3 cells)
  Row 4: ['FIREBALL CINNMN', 'CAN-US BLND-US BTLD', '2']... (showing first 3 cells)
  Row 5: ['J DNL BLACK LBL', 'DOM WHSKY-STRT-BRBN/TN', '3']... (showing first 3 cells)
  Row 6: ['CPTMRG ORG SPCD', 'RUM-FLVRD', '4']... (showing first 3 cells)
  Row 7: ['JIM BEAM', 'DOM WHSKY-STRT-BRBN/TN', '5']... (showing first 3 cells)
  Row 8: ['PLATINUM 7X', 'VODKA-CLASSIC-DOM', '6']... (showing first 3 cells)
  Row 9: ['JAMESON', 'IRISH-BLND', '7']... (showing first 3 cells)
  Row 0: 2 non-empty cells
  Row 1: 6 non-empty cells
  Row 2: 9 non-empty cells
  Row 3: 9 non-empty cells
  Row 4: 9 non-empty cells

âœ… Detected header row at index 2 (has 9 non-empty cells)
ðŸ“‹ Headers: ['BRAND', 'Type', 'Rank', '% Total', 'Case Sales', '+ or Last Year', 'Case Sales', '+ or Last Year', 'Case Sales Last Twelve Months']
ðŸ“ˆ Data rows: 100
ðŸŽ¯ Semantic fields: ['brand', 'type', 'ytd_rank', 'ytd_pct_total', 'ytd_case_sales', 'ytd_vs_last_year', 'current_month_case_sales', 'current_month_vs_last_year', 'l12m_case_sales']

âš ï¸  Duplicate headers detected! Using positional mapping.
    Headers: ['BRAND', 'Type', 'Rank', '% Total', 'Case Sales', '+ or Last Year', 'Case Sales', '+ or Last Year', 'Case Sales Last Twelve Months']
  âœ… Column 0 -> brand
  âœ… Column 1 -> type
  âœ… Column 2 -> ytd_rank
  âœ… Column 3 -> ytd_pct_total
  âœ… Column 4 -> ytd_case_sales
  âœ… Column 5 -> ytd_vs_last_year
  âœ… Column 6 -> current_month_case_sales
  âœ… Column 7 -> current_month_vs_last_year
  âœ… Column 8 -> l12m_case_sales

ðŸ“Š Final mapping: {0: 'brand', 1: 'type', 2: 'ytd_rank', 3: 'ytd_pct_total', 4: 'ytd_case_sales', 5: 'ytd_vs_last_year', 6: 'current_month_case_sales', 7: 'current_month_vs_last_year', 8: 'l12m_case_sales'}
  âœ… Record 1: {'brand': 'TITO HANDMADE', 'type': 'VODKA-CLASSIC-DOM', 'ytd_rank': '1', 'ytd_pct_total': '5.95', 'ytd_case_sales': '258678', 'ytd_vs_last_year': '2219', 'current_month_case_sales': '258678', 'current_month_vs_last_year': '2219', 'l12m_case_sales': '3810367'}
  âœ… Record 2: {'brand': 'FIREBALL CINNMN', 'type': 'CAN-US BLND-US BTLD', 'ytd_rank': '2', 'ytd_pct_total': '1.83', 'ytd_case_sales': '79494', 'ytd_vs_last_year': '-5932', 'current_month_case_sales': '79494', 'current_month_vs_last_year': '-5932', 'l12m_case_sales': '1028778'}
  âœ… Record 3: {'brand': 'J DNL BLACK LBL', 'type': 'DOM WHSKY-STRT-BRBN/TN', 'ytd_rank': '3', 'ytd_pct_total': '1.70', 'ytd_case_sales': '73851', 'ytd_vs_last_year': '-1900', 'current_month_case_sales': '73851', 'current_month_vs_last_year': '-1900', 'l12m_case_sales': '1018062'}
  âœ… Record 4: {'brand': 'CPTMRG ORG SPCD', 'type': 'RUM-FLVRD', 'ytd_rank': '4', 'ytd_pct_total': '1.52', 'ytd_case_sales': '65966', 'ytd_vs_last_year': '-625', 'current_month_case_sales': '65966', 'current_month_vs_last_year': '-625', 'l12m_case_sales': '861755'}
  âœ… Record 5: {'brand': 'JIM BEAM', 'type': 'DOM WHSKY-STRT-BRBN/TN', 'ytd_rank': '5', 'ytd_pct_total': '1.47', 'ytd_case_sales': '64052', 'ytd_vs_last_year': '228', 'current_month_case_sales': '64052', 'current_month_vs_last_year': '228', 'l12m_case_sales': '810898'}

âœ… Extracted 100 valid records

ðŸ§¹ Cleaning records...

ðŸ“‹ Sample cleaned records (first 3):

  Record 1:
    brand: TITO HANDMADE (str)
    type: VODKA-CLASSIC-DOM (str)
    ytd_rank: 1 (int)
    ytd_pct_total: 5.95 (float)
    ytd_case_sales: 258678 (int)
    ytd_vs_last_year: 2219 (int)
    current_month_case_sales: 258678 (int)
    current_month_vs_last_year: 2219 (int)
    l12m_case_sales: 3810367 (int)

  Record 2:
    brand: FIREBALL CINNMN (str)
    type: CAN-US BLND-US BTLD (str)
    ytd_rank: 2 (int)
    ytd_pct_total: 1.83 (float)
    ytd_case_sales: 79494 (int)
    ytd_vs_last_year: -5932 (int)
    current_month_case_sales: 79494 (int)
    current_month_vs_last_year: -5932 (int)
    l12m_case_sales: 1028778 (int)

  Record 3:
    brand: J DNL BLACK LBL (str)
    type: DOM WHSKY-STRT-BRBN/TN (str)
    ytd_rank: 3 (int)
    ytd_pct_total: 1.7 (float)
    ytd_case_sales: 73851 (int)
    ytd_vs_last_year: -1900 (int)
    current_month_case_sales: 73851 (int)
    current_month_vs_last_year: -1900 (int)
    l12m_case_sales: 1018062 (int)

ðŸ’¾ Attempting to insert 100 records into Supabase...
âœ… Batch insert succeeded: 100 records

================================================================================
ðŸ“Š SUMMARY
================================================================================
  Extracted records: 100
  Cleaned records:   100
  Loaded to DB:      100
  Failed:            0
  Success rate:      100.0%

ðŸŽ‰ SUCCESS! All records loaded correctly!
